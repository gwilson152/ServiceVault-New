generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id                    String              @id @default(cuid())
  name                  String?
  email                 String?             @unique
  emailVerified         DateTime?
  image                 String?
  password              String?
  preferences           Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  memberships           AccountMembership[]
  authAccounts          AuthAccount[]
  createdEmails         EmailQueue[]
  createdEmailSettings  EmailSettings[]     @relation("EmailSettingsCreator")
  updatedEmailSettings  EmailSettings[]     @relation("EmailSettingsUpdater")
  createdEmailTemplates EmailTemplate[]     @relation("EmailTemplateCreator")
  updatedEmailTemplates EmailTemplate[]     @relation("EmailTemplateUpdater")
  createdInvoices       Invoice[]
  sessions              Session[]
  systemRoles           SystemRole[]
  assignedTickets       Ticket[]            @relation("TicketAssignee")
  createdTickets        Ticket[]            @relation("TicketCreator")
  approvedTimeEntries   TimeEntry[]         @relation("TimeEntryApprover")
  timeEntries           TimeEntry[]
  timers                Timer[]

  @@index([email])
}

model Account {
  id           String               @id @default(cuid())
  name         String
  accountType  AccountType          @default(INDIVIDUAL)
  parentId     String?
  companyName  String?
  address      String?
  phone        String?
  domains      String?
  customFields Json?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  parent       Account?             @relation("AccountHierarchy", fields: [parentId], references: [id])
  children     Account[]            @relation("AccountHierarchy")
  billingRates AccountBillingRate[]
  memberships  AccountMembership[]
  settings     AccountSettings?
  invoices     Invoice[]
  tickets      Ticket[]
  timeEntries  TimeEntry[]

  @@index([parentId])
  @@index([domains])
}

model AccountMembership {
  id        String           @id @default(cuid())
  userId    String
  accountId String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  account   Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles     MembershipRole[]

  @@unique([userId, accountId])
  @@index([userId])
  @@index([accountId])
}

model RoleTemplate {
  id                    String           @id @default(cuid())
  name                  String           @unique
  description           String?
  permissions           String[]
  inheritAllPermissions Boolean          @default(false)
  isSystemRole          Boolean          @default(false)
  scope                 String           @default("account")
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  membershipRoles       MembershipRole[]
  systemRoles           SystemRole[]

  @@index([isSystemRole])
  @@index([inheritAllPermissions])
}

model MembershipRole {
  id           String            @id @default(cuid())
  membershipId String
  roleId       String
  membership   AccountMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  role         RoleTemplate      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([membershipId, roleId])
}

model SystemRole {
  id     String       @id @default(cuid())
  userId String
  roleId String
  role   RoleTemplate @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model Ticket {
  id           String        @id @default(cuid())
  ticketNumber String        @unique
  title        String
  description  String?
  status       String        @default("OPEN")
  priority     String        @default("MEDIUM")
  customFields Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  accountId    String
  creatorId    String?
  assigneeId   String?
  account      Account       @relation(fields: [accountId], references: [id])
  assignee     User?         @relation("TicketAssignee", fields: [assigneeId], references: [id])
  creator      User?         @relation("TicketCreator", fields: [creatorId], references: [id])
  addons       TicketAddon[]
  timeEntries  TimeEntry[]
  timers       Timer[]

  @@index([accountId])
  @@index([creatorId])
  @@index([assigneeId])
  @@index([status])
}

model TimeEntry {
  id               String        @id @default(cuid())
  description      String?
  minutes          Int
  date             DateTime      @default(now())
  noCharge         Boolean       @default(false)
  billingRateId    String?
  billingRateName  String?
  billingRateValue Float?
  isApproved       Boolean       @default(false)
  approvedBy       String?
  approvedAt       DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  ticketId         String?
  accountId        String?
  userId           String
  invoiceItems     InvoiceItem[]
  account          Account?      @relation(fields: [accountId], references: [id])
  approver         User?         @relation("TimeEntryApprover", fields: [approvedBy], references: [id])
  billingRate      BillingRate?  @relation(fields: [billingRateId], references: [id])
  ticket           Ticket?       @relation(fields: [ticketId], references: [id])
  user             User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([ticketId])
  @@index([accountId])
  @@index([date])
  @@index([isApproved])
}

model TicketAddon {
  id           String        @id @default(cuid())
  name         String
  description  String?
  price        Float
  quantity     Int           @default(1)
  ticketId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invoiceItems InvoiceItem[]
  ticket       Ticket        @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  status        String        @default("DRAFT")
  total         Float
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  accountId     String
  creatorId     String
  account       Account       @relation(fields: [accountId], references: [id])
  creator       User          @relation(fields: [creatorId], references: [id])
  items         InvoiceItem[]

  @@index([accountId])
  @@index([status])
}

model InvoiceItem {
  id          String       @id @default(cuid())
  description String
  quantity    Float
  rate        Float
  amount      Float
  invoiceId   String
  timeEntryId String?
  addonId     String?
  addon       TicketAddon? @relation(fields: [addonId], references: [id])
  invoice     Invoice      @relation(fields: [invoiceId], references: [id])
  timeEntry   TimeEntry?   @relation(fields: [timeEntryId], references: [id])

  @@index([invoiceId])
}

model BillingRate {
  id           String               @id @default(cuid())
  name         String               @unique
  rate         Float
  description  String?
  isDefault    Boolean              @default(false)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  accountRates AccountBillingRate[]
  timeEntries  TimeEntry[]
}

model AccountBillingRate {
  id            String      @id @default(cuid())
  accountId     String
  billingRateId String
  rate          Float
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  account       Account     @relation(fields: [accountId], references: [id])
  billingRate   BillingRate @relation(fields: [billingRateId], references: [id])

  @@unique([accountId, billingRateId])
}

model SystemSettings {
  id           String   @id @default(cuid())
  key          String   @unique
  value        String
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AccountSettings {
  id           String   @id @default(cuid())
  accountId    String   @unique
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  account      Account  @relation(fields: [accountId], references: [id])
}

model Timer {
  id         String   @id @default(cuid())
  userId     String
  ticketId   String
  startTime  DateTime @default(now())
  pausedTime Int      @default(0)
  isRunning  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ticket     Ticket   @relation(fields: [ticketId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, ticketId])
}

model EmailTemplate {
  id         String              @id @default(cuid())
  name       String              @unique
  type       EmailTemplateType
  subject    String
  htmlBody   String
  textBody   String?
  variables  String              @default("{}")
  isDefault  Boolean             @default(false)
  status     EmailTemplateStatus @default(ACTIVE)
  createdBy  String
  updatedBy  String?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  emailQueue EmailQueue[]
  creator    User                @relation("EmailTemplateCreator", fields: [createdBy], references: [id])
  updater    User?               @relation("EmailTemplateUpdater", fields: [updatedBy], references: [id])
}


model EmailQueue {
  id            String           @id @default(cuid())
  templateId    String?
  fromEmail     String
  fromName      String?
  toEmail       String
  toName        String?
  ccEmails      String?
  bccEmails     String?
  subject       String
  htmlBody      String
  textBody      String?
  variables     String           @default("{}")
  status        EmailQueueStatus @default(PENDING)
  priority      Int              @default(5)
  scheduledAt   DateTime?
  sentAt        DateTime?
  failureReason String?
  retryCount    Int              @default(0)
  maxRetries    Int              @default(3)
  createdBy     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  creator       User?            @relation(fields: [createdBy], references: [id])
  template      EmailTemplate?   @relation(fields: [templateId], references: [id])

  @@index([status])
  @@index([scheduledAt])
}

model UserPreferences {
  id          String   @id @default(cuid())
  userId      String   @unique
  preferences Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

enum AccountType {
  INDIVIDUAL
  ORGANIZATION
  SUBSIDIARY
}

enum EmailTemplateType {
  USER_INVITATION
  TICKET_UPDATE
  TICKET_STATUS_CHANGE
  TIME_ENTRY_APPROVAL
  INVOICE_GENERATED
  PASSWORD_RESET
  ACCOUNT_WELCOME
  SYSTEM_NOTIFICATION
}

enum EmailTemplateStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

enum EmailQueueStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
}
